---
title: 'Project 1: Lending Club''s data'
author: "JFdarre"
date: "September 30, 2015"
output:
  html_document:
    keep_md: true
---


# Lending club:
For this project, we wish to present and explore the data provided by Lending Club.  
Here is the website: [Lending Club](<https://www.lendingclub.com>)

Lending Club (LC) is a peer-to-peer online lending platform. It is the world’s largest marketplace connecting borrowers and investors, where consumers and small business owners lower the cost of their credit and enjoy a better experience than traditional bank lending, and investors earn attractive risk-adjusted returns.

## How it works:
1. Customers interested in a loan complete a simple application at LendingClub.com
2. LC leverage online data and technology to quickly assess risk, determine a credit rating and assign appropriate interest rates.
3. Qualified applicants receive offers in just minutes and can evaluate loan options with no impact to their credit score
4. Investors ranging from individuals to institutions select loans in which to invest and can earn monthly returns

The entire process is online, using technology to lower the cost of credit and pass the savings back in the form of lower rates for borrowers and solid returns for investors.

Here is the link to [more details](<https://www.lendingclub.com/public/how-peer-lending-works.action>) about LC.  

## Goal of the project:
We will present and explore the data provided by LC at this [address](<https://www.lendingclub.com/info/download-data.action>). This data was made available to us after the creation of an investor account.  
  
The data consists in 4 files updated every quarter on the same day as the quarterly results of the company are released. They contain information on almost all the loans issued by LC. The only loans missing from these files are the few loans where LC was not authorized to release publicly the details of the transactions.  
  
The information available for each loan consists of all the details of the loans at the time of their issuance as well as more information relative to the latest status of loan such as how much principal has been paid so far, how much interest, if the loan was fully paid or defaulted, or if the borrower is late on payments etc.

## Downloading the data:

We downloaded the 4 csv files and loaded them in our environement. We then combined them into one table that we called LC and saved it under LC.Rdata: 

```{r, eval = FALSE}
setwd('/Users/jfdarre/Documents/NYCDS/Project1')
LCA = read.csv("LC2007-2012.csv", stringsAsFactors = FALSE, header = T, skip = 1)
LCB = read.csv("LC2012-2013.csv", stringsAsFactors = FALSE, header = T, skip = 1)
LCC = read.csv("LC2013-2014.csv", stringsAsFactors = FALSE, header = T, skip = 1)
LCD = read.csv("LC2014-2015.csv", stringsAsFactors = FALSE, header = T, skip = 1)
LCE = rbind(LCA, LCB, LCC, LCD)
LC = tbl_df(LCE)
save(LC, file = "LC.RData")
rm(list=ls())
```

## Preparing for the analysis:

The next step is to load all the librabies needed for our exploration of the data:

```{r, warning = FALSE, message = FALSE}
library(ggplot2)
library(dplyr)
library(reshape)
library(ggthemes)
library(RColorBrewer)
library(maps)
library(lattice)
library(plotly)
```


```{r, echo=FALSE, results="hide"}
Sys.setenv("plotly_username"="jfdarre")
Sys.setenv("plotly_api_key"="srt1rvo0by")
```

Setting up some useful variables and loading loan data:

```{r}
rm(list=ls())
setwd('/Users/jfdarre/Documents/NYCDS/Project1')
# Date of the latest update of the reports:
report_date = 201506

# Loading the data and storing the original data into LC0:
load("LC.RData")
LC0 = LC
```

##### Here is a full description of every fields:

LoanStatNew	                | Description
--------------------------- | ----------------------------------------------------------------------------------------
zip_code                    | The first 3 numbers of the zip code provided by the borrower in the loan application.
addr_state                  | The state provided by the borrower in the loan application
annual_inc                  | The annual income provided by the borrower during registration.
collection_recovery_fee     | post charge off collection fee
collections_12_mths_ex_med  | Number of collections in 12 months excluding medical collections
delinq_2yrs                 | The number of 30+ days past-due incidences of delinquency in the borrower's credit file for the past 2 years
desc                        | Loan description provided by the borrower
dti                         | A ratio calculated using the borrower’s total monthly debt payments on the total debt obligations, excluding mortgage and the requested LC loan, divided by the borrower’s self-reported monthly income.
earliest_cr_line            | The month the borrower's earliest reported credit line was opened
emp_length                  | Employment length in years. Possible values are between 0 and 10 where 0 means less than one year and 10 means ten or more years. 
emp_title                   | The job title supplied by the Borrower when applying for the loan.
fico_range_high             | The upper boundary of range the borrower’s FICO belongs to.
fico_range_low              | The lower boundary of range the borrower’s FICO belongs to.
funded_amnt                 | The total amount committed to that loan at that point in time.
funded_amnt_inv             | The total amount committed by investors for that loan at that point in time.
grade                       | LC assigned loan grade
home_ownership              | The home ownership status provided by the borrower during registration. Our values are: RENT, OWN, MORTGAGE, OTHER.
id                          | A unique LC assigned ID for the loan listing.
initial_list_status         | The initial listing status of the loan. Possible values are – W, F
inq_last_6mths              | The number of inquiries by creditors during the past 6 months.
installment                 | The monthly payment owed by the borrower if the loan originates.
int_rate                    | Interest Rate on the loan
is_inc_v                    | Indicates if income was verified by LC, not verified, or if the income source was verified
issue_d                     | The month which the loan was funded
last_credit_pull_d          | The most recent month LC pulled credit for this loan
last_fico_range_high        | The last upper boundary of range the borrower’s FICO belongs to pulled.
last_fico_range_low         | The last lower boundary of range the borrower’s FICO belongs to pulled.
last_pymnt_amnt             | Last total payment amount received
last_pymnt_d                | Last month payment was received
loan_amnt                   | The listed amount of the loan applied for by the borrower. If at some point in time, the credit department reduces the loan amount, then it will be reflected in this value.
loan_status                 | Current status of the loan
member_id                   | A unique LC assigned Id for the borrower member.
mths_since_last_delinq      | The number of months since the borrower's last delinquency.
mths_since_last_major_derog | Months since most recent 90-day or worse rating
mths_since_last_record      | The number of months since the last public record.
next_pymnt_d                | Next scheduled payment date
open_acc                    | The number of open credit lines in the borrower's credit file.
out_prncp                   | Remaining outstanding principal for total amount funded
out_prncp_inv               | Remaining outstanding principal for portion of total amount funded by investors
policy_code                 | Publicly available policy_code=1, new products not publicly available policy_code=2
pub_rec                     | Number of derogatory public records
purpose                     | A category provided by the borrower for the loan request. 
pymnt_plan                  | Indicates if a payment plan has been put in place for the loan
recoveries                  | post charge off gross recovery
revol_bal                   | Total credit revolving balance
revol_util                  | Revolving line utilization rate, or the amount of credit the borrower is using relative to all available revolving credit.
sub_grade                   | LC assigned loan subgrade
term                        | The number of payments on the loan. Values are in months and can be either 36 or 60.
title                       | The loan title provided by the borrower
total_acc                   | The total number of credit lines currently in the borrower's credit file
total_pymnt                 | Payments received to date for total amount funded
total_pymnt_inv             | Payments received to date for portion of total amount funded by investors
total_rec_int               | Interest received to date
total_rec_late_fee          | Late fees received to date
total_rec_prncp             | Principal received to date
url                         | URL for the LC page with listing data.


Now let's have a look at some examples to understand the fields:

```{r}
# illustrative example
t(filter(LC0, id == 36805548))

# looking for loans that were delinquent at some point in time, and looking at an example
filter(LC, recoveries != 0)
# looking for loans that were delinquent at some point in time, and looking at an example
t(filter(LC, id == 1069559))
```

#### Useful functions:

To facilitate our discovery and manipulation of the data we created some useful functions that will be used repetitively:

```{r}
# used to create FICO bins to group fico scores
bin_name = function(x) {
  low = 490 + (x - 1) * 30
  high = low + 30
  paste(low, high, sep = "-")
}

# used to generate summaries grouping by ... and showing how much loan amount is in each status
sumPerSatus = function(x, ...){
  x %>% group_by(...) %>%
    summarize(., charged   = round(sum(loan_status_new == "Charged Off") / n() * 100, 2),
                 net_EL    = round(sum((1 - total_rec_prncp / funded_amnt) * 100) / n(), 2),
                 avg_fico  = round(mean(fico_range_high)),
                 avg_grade = sub_grade_vec[mean(LC_score)])
}

# used to generate summaries grouping by ... and showing how much loan amount and how many loans were issued by groups
sumAmnts = function(x, ...) {
  x %>% group_by(., ...) %>%
    summarise(., total_issued = prettyNum(round(sum(loan_amnt/1)),big.mark = ","),
              n = prettyNum(round(n()),big.mark = ","))
}

# used to generate summaries grouping by ... and showing how much loan amount, principal out and recieved principle
# remove the "pretty numbers" to enable the use of the results in formula
sumAmnt = function(x, ...) {
  x %>% group_by(., ...) %>%
    summarise(., total_issued = round(sum(loan_amnt/1e6),1),
              n = round(n()))
}

# used to generate summaries grouping by ... and showing usefull statics about each group
sumStats = function(x, ...) {
  x %>% group_by(., ...) %>%
    summarise(., median = prettyNum(round(median(loan_amnt/1)),big.mark = ","),
              average = prettyNum(round(mean(loan_amnt/1)),big.mark = ","),
              stdev = prettyNum(round(sd(loan_amnt/1)),big.mark = ","))
}

# used to generate summaries grouping by ... and showing usefull statics about each group
# remove the "pretty numbers" to enable the use of the results in formula
sumStat = function(x, ...) {
  x %>% group_by(., ...) %>%
    summarise(., median = round(median(loan_amnt/1)),
              average = round(mean(loan_amnt/1)),
              stdev = round(sd(loan_amnt/1)))
}

# calculating retrun on investment
roi = function(x, ...){
  x %>% group_by(...) %>%
    summarize(., roi       = round(sum((total_pymnt / funded_amnt) * 100) / n(), 2))
}


```


## Modifying, cleaning the data and adding useful columns to the original data:

Now that we have prepared the grounds for our analysis we need to clean up the data and add some fields that will prove useful for our analysis.

First, we will clean the data by removing some corrupted loans. Note that for every entry that we remove, we check the sum of the loan amounts to judge how much of the data we are removing. In the end we will remove around USD 10 mm worth of loans, which corresponds to 0.1% of the total. This is perfectly acceptable.

```{r}
# removing policy_code == 2, i.e. "not public" and then removing the comlumn
sum(filter(LC0, policy_code != 1)$loan_amnt, na.rm = T)
LC = filter(LC, policy_code == 1)
LC = select(LC, -policy_code)

# removing 28 records with a lot of missing data:
sum(filter(LC0, is.na(pub_rec))$loan_amnt, na.rm = T)
LC = filter(LC, !is.na(pub_rec))

# Filtering out the entries where last_fico_range_high = 0
sum(filter(LC0, last_fico_range_high == 0)$loan_amnt, na.rm = T)
LC = filter(LC, last_fico_range_high != 0)

# Removing the loans without any entry for revol_util
sum(filter(LC0, revol_util == "")$loan_amnt, na.rm = T)
LC = filter(LC, revol_util != "")

# Removing the loans with fico scores < 660 as they are very few of them, and LC changed their
# policy and does not issue loan for scores below 660
sum(filter(LC0, fico_range_high < 660)$loan_amnt, na.rm = T)
LC = filter(LC, fico_range_high >= 660)

# Removing "Does not meet the credit policy.  Status:" from:
# Does not meet the credit policy.  Status:Charged Off
# Does not meet the credit policy.  Status:Current
# Does not meet the credit policy.  Status:Fully Paid
LC = mutate(LC, loan_status_new =
                ifelse(grepl("Does not meet the credit policy.  Status:", loan_status),
                       gsub("Does not meet the credit policy.  Status:","",loan_status),
                       loan_status))
```

Now we modify and add features to our remaining data set. These features will be key in our analysis. We are converting dates and characters to numeric to enable calculations as well as creating buckets to enable classifications:

```{r}
# adding issue year, quarter
# adding FICO scores buckets
Months = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
LC = mutate(LC, issue_y = strtoi(substr(issue_d, 5, 9)),
                issue_m = match(substr(issue_d, 1, 3),Months),
                issue_ym = issue_y * 100 + issue_m,
                issue_q = ceiling(issue_m / 3),
                issue_yq = paste(issue_y, "-Q", issue_q, sep = ""),
                n = 1)

# FICO buckets for future visualizations
LC = mutate(LC, FICO_buckets_Original = ceiling((fico_range_high - 490) / 30),
                FICO_buckets_Last = ceiling((fico_range_high - 490) / 30),
                FICO_bin_name_Original = sapply(FICO_buckets_Original, bin_name),
                FICO_bin_name_Last = sapply(FICO_buckets_Last, bin_name))

# Add a feature "matured" for Loans that have or would have matured by report_date
LC = mutate(LC, matured = ifelse((issue_ym + ifelse(term == " 36 months", 300, 500)) > report_date, F, T))

# reduce the number of categories of purpose
LC = mutate(LC, purpose_new = ifelse(purpose == "credit_card" | 
                                       purpose == "debt_consolidation", "debt",
                              ifelse(purpose == "car" | 
                                       purpose == "major_purchase" | 
                                       purpose == "vacation" | 
                                       purpose == "wedding" | 
                                       purpose == "medical" | 
                                       purpose == "other", "purchase",
                              ifelse(purpose == "house" | 
                                       purpose == "home_improvement" | 
                                       purpose == "moving" | 
                                       purpose == "renewable_energy", "purchase", purpose))))

# reduce the number of categories of purpose
LC = mutate(LC, home = ifelse(home_ownership == "ANY" | home_ownership == "NONE", "OTHER", home_ownership))

# give LC grade numeric values
sub_grade_vec = unique(LC$sub_grade) %>% .[order(., decreasing = T)]
LC = mutate(LC, LC_score = match(sub_grade, sub_grade_vec))

# adding a feature credit_ym corresponding to how many years old is the credit history of a borrower:
LC = mutate(LC, 
        credit_ym = round(((floor(issue_ym/100)*100 + 
                            ((issue_ym - floor(issue_ym/100)*100)-1)/12*100)
                         - (strtoi(substr(earliest_cr_line, 5, 9)) * 100 + 
                              (match(substr(earliest_cr_line, 1, 3),Months)-1)/12*100))/100,1))

# creating issue_y buckets:
LC = mutate(LC, issue_bucket = ifelse(issue_y <= 2012, "2007-2012", issue_y))

# delinq_2yrs buckets:
LC = mutate(LC, delinq_bucket = ifelse(delinq_2yrs >= 2, "2+", delinq_2yrs))

# inq_last_6mths buckets:
LC = mutate(LC, inq_bucket = ifelse(inq_last_6mths >= 7, "7+", 
                             ifelse(inq_last_6mths >= 5, "5-6", 
                             ifelse(inq_last_6mths >= 3, "3-4", 
                             ifelse(inq_last_6mths >= 1, "1-2", 0)))))

# public record buckets: 
LC = mutate(LC, rec_bucket = #ifelse(pub_rec >= 10, "10+", 
                             #ifelse(pub_rec >= 7, "7-9", 
                             #ifelse(pub_rec >= 4, "4-6", 
                             ifelse(pub_rec >= 1, "1+", 0))#)))

# Annual income quantile buckets:
groupvec = quantile(LC$annual_inc, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LC = mutate(LC, annual_inc_bucket = cut(LC$annual_inc, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# DTI quantile buckets:
groupvec = quantile(LC$dti, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LC = mutate(LC, dti_bucket = cut(LC$dti, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# Revolving balance quantile buckets:
LC = mutate(LC, revol = as.numeric(gsub("%","",revol_util)))
groupvec = quantile(LC$revol, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LC = mutate(LC, revol_bucket = cut(LC$revol, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# Revolving balance quantile buckets:
groupvec = quantile(LC$revol_bal, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LC = mutate(LC, revol_bal_bucket = cut(LC$revol_bal, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# total accounts buckets:
groupvec = quantile(LC$total_acc, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LC = mutate(LC, total_acc_bucket = cut(LC$total_acc, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# open accounts buckets:
groupvec = quantile(LC$open_acc, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LC = mutate(LC, open_acc_bucket = cut(LC$open_acc, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# credit_y quantile buckets:
groupvec = quantile(LC$credit_ym, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LC = mutate(LC, credit_ym_bucket = cut(LC$credit_ym, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))
```

We also create a subset of our modified data. This subset will correspond to all the loans that have or would have matured by the time of the report. The loans with 3 years of maturity may have been issued all the way to Jun-2012 as we recall that our current reports are as of Jun-2015. Similarly, the loans with 5 years of maturity will be selected only if they were issued before Jun-2010.

This subset will be called LCmatured and will enable us to extract true default rates by comparing solely loans whose final status is know with certainty.

Note that we will have to over-write the quantile buckets that we just created on our dataset LC to adjust them to our new subset LCmatured.

```{r}
# create sub table of only the matured loans:
LCmatured = filter(LC, matured == T)

# we'll re-do the quantile buckets for LCmatured to adjust them:
# Annual income quantile buckets:
groupvec = quantile(LCmatured$annual_inc, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LCmatured = mutate(LCmatured, annual_inc_bucket = cut(LCmatured$annual_inc, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# DTI quantile buckets:
groupvec = quantile(LCmatured$dti, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LCmatured = mutate(LCmatured, dti_bucket = cut(LCmatured$dti, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# Revolving balance utilization quantile buckets:
# First we need to mutate a field to convert them to numeric:
groupvec = quantile(LCmatured$revol, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LCmatured = mutate(LCmatured, revol_bucket = cut(LCmatured$revol, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# Revolving balance quantile buckets:
groupvec = quantile(LCmatured$revol_bal, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LCmatured = mutate(LCmatured, revol_bal_bucket = cut(LCmatured$revol_bal, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# total accounts buckets:
groupvec = quantile(LCmatured$total_acc, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LCmatured = mutate(LCmatured, total_acc_bucket = cut(LCmatured$total_acc, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# open accounts buckets:
groupvec = quantile(LCmatured$open_acc, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LCmatured = mutate(LCmatured, open_acc_bucket = cut(LCmatured$open_acc, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))

# credit_y quantile buckets:
groupvec = quantile(LCmatured$credit_ym, seq(0,1,0.1))
labels = c(0, prettyNum(groupvec[2:10], big.mark = ","), "+inf")
labels = paste(labels[1:10], labels[2:11], sep = "-")
LCmatured = mutate(LCmatured, credit_ym_bucket = cut(LCmatured$credit_ym, breaks = groupvec, labels = factor(labels), include.lowest=TRUE))
```

## First look at the data, exploratory research:

Looking at loan amounts types and loan amounts in each category
```{r}
# Looking at loan amounts types and loan amounts in each category
# Smallest loan:
min(LC$loan_amnt)
# Largest loan:
max(LC$loan_amnt)
# Total amount of loans in USD millon 
prettyNum(round(sum(LC$loan_amnt/1e6), 1),big.mark = ",")
# Total amount of loans in USD millon using the original data:
prettyNum(round(sum(LC0$loan_amnt/1e6, na.rm = T),1), big.mark = ",")
```

Looking at the distribution of the loans relative to their latest status:
```{r, fig.width=10}
# Looking at total loan amnts per loan_status
# Report showing the amounts and number of loans in each category, here the latest status of the loans
sumAmnts(LC, loan_status_new)
# Report showing some statistics for each category, here the latest status of the loans
sumStats(LC, loan_status_new)
# Pie chart of the distribution of Loans across the different status:
sumAmnt(LC, loan_status_new) %>% merge(sumPerSatus(LC, loan_status_new)) %>%
  plot_ly(type = "pie", 
          labels = loan_status_new, 
          values = total_issued, 
          hole = 0.5,
          marker = list(colors = brewer.pal(7, "Pastel2"),
                        line = list(width = 1, color = "rgb(52, 110, 165)")),
          sort = F,
          direction = "counterclockwise",
          rotation = 90,
          textinfo = "label+percent",
          textfont = list(size = 14),
          text = paste("Default rates: ", charged),
          opacity = 1,
          textposition = "outside") %>%
  layout(title = 'LOAN ISSUED GROUPED BY STATUS<br>(Hover for breakdown)',
         height = 500, width = 1400, autosize = T, 
         legend = list(font = list(size = 16), x = 1, y = 1, traceorder = "normal"))
```

Looking at Lending Club's issuances over the years:
```{r, fig.width=10}
# Summary by issue year
# Report showing the amounts and number of loans in each category, here the year of issuance
sumAmnts(LC, issue_y)
# Report showing some statistics for each category, here the year of issuance
sumStats(LC, issue_y)
# Bar chart of LC's quaterly loan issuance
sumAmnt(LC, issue_yq) %>%
  plot_ly(type = "bar", 
          x = issue_yq,
          y = total_issued,
          marker = list(color = total_issued,
                        colorscale = list(c(0, "rgb(201, 218, 248)"), list(1, "rgb(61, 133, 198)")),
                        line = list(width = 1, color = "rgb(255, 255, 255)"))
  ) %>%
  layout(title = "QUATERLY LOAN ISSUANCE", bargap = 0,
         yaxis = list(title = "TOTAL LOAN ISSUED IN MLN USD"),
         xaxis = list(title = "YEAR OF ISSUE", range = c(7,32.5), dtick = 2))
```

Looking at Lending Club's issuances over the United States:
```{r, echo=FALSE}
# vector of all states' abbreviations:
addr_state = c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA",
              "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD",
              "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ",
              "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC",
              "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")
# vector of all states' names:
state_name =  c("Alabama",        "Alaska",         "Arizona",        "Arkansas",       "California",     "Colorado",      
                "Connecticut",    "Delaware",       "Florida",        "Georgia",        "Hawaii",         "Idaho",
                "Illinois",       "Indiana",        "Iowa",           "Kansas",         "Kentucky",       "Louisiana",     
                "Maine",          "Maryland",       "Massachusetts",  "Michigan",       "Minnesota",      "Mississippi",   
                "Missouri",       "Montana",        "Nebraska",       "Nevada",         "New Hampshire",  "New Jersey",    
                "New Mexico",     "New York",       "North Carolina", "North Dakota",   "Ohio",           "Oklahoma",      
                "Oregon",         "Pennsylvania",   "Rhode Island",   "South Carolina", "South Dakota",   "Tennessee",     
                "Texas",          "Utah",           "Vermont",        "Virginia",       "Washington",     "West Virginia", 
                "Wisconsin",      "Wyoming")
```

```{r, fig.width=10}
# Preparing our data for the plot:
sumStates = group_by(LC, addr_state) %>%
  summarise(., total_issued = round(sum(loan_amnt/1e6),1), n = n()) %>%
  merge(sumPerSatus(LC, addr_state)[,c(1,2)]) %>%
  merge(data.frame(addr_state, state_name))
# adding the text for the hovering functionality:
sumStates$hover = with(sumStates, paste(state_name, '<br>', 
                                         "Total amount issued:", prettyNum(total_issued, big.mark = ","), "<br>", 
                                         "Number of issued loans:", prettyNum(n, big.mark = ","), "<br>",
                                         "Default rates:", charged))
# because the range of values is to large, the map looks white aside of california and a few other states.
# To avoid this we limit the the values to a maximum, here 500.
sumStates$map_amnt = with(sumStates, pmin(total_issued, 500))
# options for the markers:
l <- list(color = toRGB("steelblue"), width = 1)
# options for the geo:
g = list(scope = 'usa', projection = list(type = 'albers usa'), showlakes = F, lakecolor = toRGB('white'))
# plot of the map of issuance made by lending club so far by state:
plot_ly(sumStates, 
        z = map_amnt, 
        text = hover, 
        locations = addr_state, 
        type = 'choropleth',
        locationmode = 'USA-states', 
        color = map_amnt, 
        colors = 'Purples',
        colorscale = list(c(0, "rgb(201, 218, 248)"), list(1, "rgb(61, 133, 198)")),
        marker = list(line = l), 
        colorbar = list(title = "Amount Issued <br>in millions USD")) %>%
  layout(title = toupper('Total loan amount issued though LC<br>(Hover for breakdown)'), geo = g)
```

Looking at different statistics and distributions of LC grades:
```{r, fig.width=10}
# Looking at grade statistics:
# Report showing the amounts and number of loans in each category, here LC grades
sumAmnts(LC, grade)
# Same report as above but constrained to LCmatured for comparison:
sumAmnts(LCmatured, grade)
# Report showing some statistics for each category, here LC grades
sumStats(LC, grade)
# Same report as above but constrained to LCmatured for comparison:
sumStats(LCmatured, grade)
# Report showing charge off rates, average LC scores and FICO scores for each category, here LC grades
sumPerSatus(LC, grade)
# Same report as above but constrained to LCmatured for comparison:
sumPerSatus(LCmatured, grade)
# Pie chart of the distribution of Loans across the different LC grades:
sumAmnt(LC, grade) %>% merge(sumPerSatus(LC, grade)) %>%
  plot_ly(type = "pie", 
          labels = grade, 
          values = total_issued, 
          hole = 0.5,
          marker = list(colors = brewer.pal(7, "Pastel2"),
                        line = list(width = 1, color = "rgb(52, 110, 165)")),
          sort = F,
          opacity = 1,
          direction = "counterclockwise",
          rotation = 120,
          textinfo = "label+percent",
          textfont = list(size = 14),
          text = paste("Default rates: ", charged),
          textposition = "outside") %>%
  layout(title = 'LOAN ISSUED GROUPED BY GRADES<br>(Hover for breakdown)',
         height = 731, width = 1274, autosize = T, 
         legend = list(font = list(size = 16), x = 0.88, y = 1, traceorder = "normal"))
```

Looking at different statistics and distributions across the different FICO buckets:
```{r, fig.width=10}
# Now let's have a look at FICO scores:
# Report showing the amounts and number of loans in each category, here the FICO score buckets
sumAmnts(LC, FICO_bin_name_Original)
# Report showing some statistics for each category, here the FICO score buckets
sumStats(LC, FICO_bin_name_Original)
# Report showing charge off rates, average LC scores and FICO scores for each category, here the FICO score buckets
sumPerSatus(LC, FICO = FICO_bin_name_Original)
# Same report as above but constrained to LCmatured for comparison:
sumPerSatus(LCmatured, FICO = FICO_bin_name_Original)
# Pie chart of the distribution of Loans across the different FICO score buckets:
sumAmnt(LC, FICO_bin_name_Original) %>% merge(sumPerSatus(LC, FICO_bin_name_Original)) %>%
  plot_ly(type = "pie", 
          labels = FICO_bin_name_Original, 
          values = total_issued, 
          hole = 0.5,
          marker = list(colors = brewer.pal(7, "Pastel2"),
                        line = list(width = 1, color = "rgb(52, 110, 165)")),
          sort = F,
          direction = "counterclockwise",
          rotation = 120,
          textinfo = "label+percent",
          textfont = list(size = 14),
          text = paste("Default rates: ", charged),
          opacity = 1,
          textposition = "outside") %>%
  layout(title = 'LOAN ISSUED GROUPED BY FICO SCORES<br>(Hover for breakdown)',
         height = 731, width = 1274, autosize = T, 
         legend = list(font = list(size = 16), x = 0.88, y = 1, traceorder = "normal"))
```

## Second look at the data: Exploration of the relationship between FICO and LC scores:

FICO scores have been implemented to assess the credit worthiness of potential borrowers. A model that Lending Club could have used could have been to simply rely on the foundation of FICO's scores. The majority of the mortgage industry relies on FICO scores to issue mortgages of 100s of thousands.

Hence our interest in looking into LC's grade system and more specifically if they have an obvious linear relationship with FICO scores.

At first, it seems obvious that the LC grades and FICO scores are very correlated:
```{r, fig.width=10}
# plot 1 shows the average fico scores of the borrowers against their LC grade:
# as expected, we see that the lower your fico score the worst your LC grade is going to be
gradeVSfico = group_by(LC, grade) %>% summarise(., avg_fico = mean(fico_range_high))
qplot(grade, avg_fico, data = gradeVSfico, geom = "boxplot", color = grade) +
  theme_bw() +
  scale_color_brewer(palette="Pastel2") +
  xlab(toupper("LC Grades ranging from A to G")) +
  ylab("FICO SCORES") +
  ggtitle("AVERAGE FICO SCORE VS. LC GRADES")
```

But this graph already seems to imply otherwise. Indeed 20 of the 35 possible LC sub grades have average FICO scores within 10pts:
```{r, fig.width=10}
# plot 2 shows the average fico scores of the borrowers against their LC sub_grade:
# grades ranging from D1 to G5 (20 levels) have average fico scores ranging from 678 to 688!
sub_gradeVSfico = group_by(LC, sub_grade) %>% summarise(., avg_fico = mean(fico_range_high))
qplot(x = sub_grade, y = avg_fico, data = sub_gradeVSfico, group = 1, geom = "point", size = I(4), color = I("steelblue")) + 
  theme_bw() + 
  scale_color_brewer(palette="Pastel2") +
  geom_hline(y = 688, color = "red", lty = 2) + 
  geom_hline(y = 678, color = "red", lty = 2) + 
  xlab(toupper("LC SUB Grades ranging from A1 to G5")) +
  ylab("FICO SCORES") +
  ggtitle(toupper("Average FICO score vs. LC SUB Grades"))
```

Running the full distribution of FICO ratings per LC grade confirm our previous point. Grades E, F, G and arguably D and even C have very close distributions and medians:
```{r, fig.width=10}
# plot 3 shows the distribution of fico scores of the borrowers against their LC's grade:
# although there is a trend, we can see on this plot that some borrowers with very high FICO scores
# got really poor LC Grade
qplot(grade, fico_range_high, data = LC, geom = "boxplot", color = grade) +
  theme_bw() +
  scale_color_brewer(palette="Pastel2") +
  xlab(toupper("LC Grades ranging from A to G")) +
  ylab("FICO SCORES") +
  ggtitle(toupper("Box plot of the FICO score distribution for each LC Grades"))
```

Looking at the densities adds to our previous points too:
```{r, fig.width=10}
# plot 4 shows the densities of fico scores of the borrowers against their LC's grade:
# there seems to be a cutoff where if your FICO score is below the trigger then it will be impossible
# to get a LC grade of A, B or C.
# we can also see that there are no obvious differences between D, E, F and G and we'll need to explore further.
qplot(grade, fico_range_high, data = LC, geom = "violin", color = grade) +
  theme_bw() +
  scale_color_brewer(palette="Pastel2") +
  xlab(toupper("LC Grades ranging from A to G")) +
  ylab("FICO SCORES") +
  ggtitle(toupper("Box plot of the FICO score distribution for each LC Grades"))
```

It is very interesting to see how these densities have evolved over the years. We can see how Lending Club's earlier model used to rely on FICO score heavily and over the course of the years, LC refined their credit models using the data that they started accumulating. It is particularly obvious when looking at the grade A. Its density changed from being condensed over a range FICO scores of 730 to 820 to a density that covers the entire FICO range with a mean that is lower than the minimum score they used to require to get an A rating:
```{r, fig.width=10}
# plot 5 is the same as plot 4 but "warpped" over the years.
# this plot shows how much LC's methodology has evolved over the years
# we see that in 2009 LC seems to have introduced a cutoff at 660 for the loans available to the public
# from 2010 to 2015 we can observe that the distributions are scretching more and more reflecting the fact
# that LC's model is relying less and less on FICO scores and probably more and more on their own data.
qplot(factor(issue_y), fico_range_high, data = filter(LC, grade != "G"), geom = "violin", color = grade) +
  theme_bw() +
  scale_color_brewer(palette="Pastel2") +
  xlab(toupper("LC Grades ranging from A to G")) +
  ylab("FICO SCORES") +
  ggtitle(toupper("Box plot of the FICO score distribution for each LC Grades")) +
  facet_wrap( ~ grade, ncol = 2)
```

## Third look at the data: Exploration and discovery of the predictive strength of each feature:

In this section we will take each features given at the time of the origination of the debt and attempt to extract their relation to default rates. For this part of the analysis we will use the data set LCmatured that we recall contains only the loans that have matured or if defaulted, would have matured.

#### Home ownership:
Home ownership: Does home ownership have any relashionship with LC grades, FICO scores and Charge Off rates?
```{r, fig.width=10}
# Report showing the amounts and number of loans in each category, here the home ownership status of the borrower.
sumAmnts(LCmatured, home)
# Report showing some statistics for each category, here the home ownership status of the borrower.
sumPerSatus(LCmatured, home)
# Home ownership: here is a bubble graph of our 4 home ownership categories:
sumAmnt(LCmatured, home) %>% merge(sumPerSatus(LCmatured, home)) %>%
plot_ly(x = n, 
        y = charged, 
        size = total_issued,
        text = paste(home, "<br>", "Total Issued: ", prettyNum(total_issued, big.mark = ",")),
        mode = "markers", 
        marker = list(color = net_EL,
                      colorscale = list(c(0, "rgb(201, 218, 248)"), list(1, "rgb(61, 133, 198)")),
                      colorbar = list(title = "Net Expected Loss"),
                      cauto = F,
                      cmin = 6,
                      cmax = 13,
                      opacity = 0.6,
                      line = list(size = 2))
        )%>%
  layout(xaxis = list(title = toupper("Number of issued loans")),
         yaxis = list(title = toupper("Default rates"), range = c(-2, 25)),
         title = 'LOAN ISSUED GROUPED BY HOME OWNERSHIP<br>(Hover for breakdown)')
# Home ownership: here is a pie chart of our 4 home ownership categories:
sumAmnt(LCmatured, home) %>% merge(sumPerSatus(LCmatured, home)) %>%
  plot_ly(type = "pie", 
          labels = home, 
          values = total_issued, 
          hole = 0.5,
          marker = list(colors = brewer.pal(4, "Pastel2"),
                        line = list(width = 1, color = "rgb(52, 110, 165)")),
          sort = F,
          direction = "counterclockwise",
          rotation = -45,
          textinfo = "label+percent",
          textfont = list(size = 14),
          text = paste("Default rates: ", charged),
          opacity = 1,
          textposition = "outside") %>%
  layout(title = 'LOAN ISSUED GROUPED BY HOME OWNERSHIP<br>(Hover for breakdown)',
         height = 731, width = 1274, autosize = T, 
         legend = list(font = list(size = 16), x = 0.88, y = 1, traceorder = "normal"))
```

#### Purpose:
Purpose: We want to see if there is any relation between LC Grades, FICO scores, Charge Off rates and purpose.
There is a strong correlation between charge off rates and if the purpose is either **educational** or **small business**.
These loans tend to be a lot riskier. The fico score does not reflect this while the LC score seems to partially capture that risk:
```{r, fig.width=10}
# Report showing the amounts and number of loans in each category, here the purpose of the borrower.
sumAmnts(LCmatured, purpose_new)
# Report showing some statistics for each category, here the purpose of the borrower.
sumPerSatus(LCmatured, purpose_new)
# Home ownership: here is a bubble graph of our 4 home ownership categories:
sumAmnt(LCmatured, purpose_new) %>% merge(sumPerSatus(LCmatured, purpose_new)) %>%
plot_ly(x = n, 
        y = charged, 
        size = total_issued,
        text = paste(purpose_new, "<br>", "Total Issued: ", prettyNum(total_issued, big.mark = ",")),
        mode = "markers", 
        marker = list(color = net_EL,
                      colorscale = list(c(0, "rgb(201, 218, 248)"), list(1, "rgb(61, 133, 198)")),
                      colorbar = list(title = "Net Expected Loss"),
                      cauto = F,
                      cmin = 7,
                      cmax = 13,
                      opacity = 0.6,
                      line = list(size = 2))
        )%>%
  layout(xaxis = list(title = toupper("Number of issued loans")),
         yaxis = list(title = toupper("Default rates"), range = c(-2, 25)),
         title = 'LOAN ISSUED GROUPED BY PURPOSE<br>(Hover for breakdown)')
# Home ownership: here is a pie chart of our different purposes categories:
sumAmnt(LCmatured, purpose_new) %>% merge(sumPerSatus(LCmatured, purpose_new)) %>%
  plot_ly(type = "pie", 
          labels = purpose_new, 
          values = total_issued, 
          hole = 0.5,
          marker = list(colors = brewer.pal(4, "Pastel2"),
                        line = list(width = 1, color = "rgb(52, 110, 165)")),
          sort = F,
          direction = "counterclockwise",
          rotation = -45,
          textinfo = "label+percent",
          textfont = list(size = 14),
          text = paste("Default rates: ", charged),
          opacoty = 0.85,
          textposition = "outside") %>%
  layout(title =  'LOAN ISSUED GROUPED BY PURPOSE<br>(Hover for breakdown)',
         height = 731, width = 1274, autosize = T, 
         legend = list(font = list(size = 16), x = 0.88, y = 1, traceorder = "normal"))

```

#### Revolvoving balance and employement length:
Revolving Balance, along with Employment length are actually the features with the least obvious link to default rates:
```{r}
# Report showing the amounts and number of loans in each category, here the revolving balance of the borrower.
sumAmnts(LCmatured, revol_bal_bucket)
# Report showing some statistics for each category, here the revolving balance of the borrower.
sumPerSatus(LCmatured, revol_bal_bucket)
# Report showing the amounts and number of loans in each category, here the employement length of the borrower.
sumAmnts(LCmatured, emp_length)[c(12,1,2,4,5,6,7,8,9,10,11,3),]
# Report showing some statistics for each category, here the employement length of the borrower.
sumPerSatus(LCmatured, emp_length)[c(12,1,2,4,5,6,7,8,9,10,11,3),]
```

#### Number of delinquencies over the past 2 years prior the application for a loan:
Number of delinquencies during the past 2 years: This feature is somewhat linked to charge off rates but a vast majority of the borrowers actually have 0 delinquencies, which is not helpful distinguishing between them.
```{r}
# Report showing the amounts and number of loans in each category, here the number of delinquencies of the borrower.
sumAmnts(LCmatured, delinq_bucket)
# Report showing some statistics for each category, here the number of delinquencies of the borrower.
sumPerSatus(LCmatured, delinq_bucket)
```

#### Number of opened and total number of accounts:
Total number of accounts and Open accounts are not the most impactful features.  
Fully paying borrower tend to have slightly more accounts but too many accounts may be bad too. This is interesting because FICO considers that the more accounts. This is also confirmed in the numbers below.
```{r}
# Report showing the amounts and number of loans in each category, here the total number of accounts of the borrower.
sumAmnts(LCmatured, total_acc_bucket)
# Report showing some statistics for each category, here the total number of accounts of the borrower.
sumPerSatus(LCmatured, total_acc_bucket)
# Report showing the amounts and number of loans in each category, here the number of opened accounts of the borrower.
sumAmnts(LCmatured, open_acc_bucket)
# Report showing some statistics for each category, here the number of opened accounts of the borrower.
sumPerSatus(LCmatured, open_acc_bucket)
```

#### DTI (Debt To Income ratio):
The DTI ratio: the lower the better, a DTI of 5 means your debts payment excluding mortgage, are only 5% of your gross income.
DTI vs LC Grade, although having the expected trend, does not seem to show an strong dependency.
DTI vs FICO score show a strong relationship for scores ranging from 700-850 but no correlation for scores < 700.
But overall DTI has some impact on charge off probabilities.
```{r, fig.width=10}
# Report showing the amounts and number of loans in each category, here the DTI of the borrower.
sumAmnts(LCmatured, dti_bucket)
# Report showing some statistics for each category, here the DTI of the borrower.
sumPerSatus(LCmatured, dti_bucket)
# Boxplot of the distribution the DTI for each grade:
qplot(grade, dti, data = LC, geom = "boxplot", color = grade) +
  theme_bw() +
  scale_color_brewer(palette="Pastel2") +
  xlab(toupper("LC Grades ranging from A to G")) +
  ylab(toupper("DTI (Debt to income ratio, in percent")) +
  ggtitle(toupper("DTI distribution vs. LC Grades"))
# Boxplot of the distribution the DTI for each FICO score bucket:
qplot(FICO_bin_name_Original, dti, data = filter(LC, fico_range_high >= 660 ) , geom = "boxplot", color = FICO_bin_name_Original) +
  theme_bw() +
  scale_color_brewer(palette="Pastel2") +
  xlab(toupper("FICO score buckets")) +
  ylab(toupper("DTI (Debt to income ratio, in percent")) +
  ggtitle(toupper("Average FICO score vs. LC Grades"))
```

#### Public records:
Public Records: This feature is definitely correlated to charged off rates, but its value is very low. It is zero in most cases.
Basically if a borrower has 0 public records is a strong indicator that he has greater chances to pay off his debts and conversely, if the number of public records is greater than 0, the borrower has a substantially greater chance of default.
```{r}
# Report showing the amounts and number of loans in each category, here the number of public records of the borrower.
sumAmnts(LCmatured, rec_bucket)
# Report showing some statistics for each category, here the number of public records of the borrower.
sumPerSatus(LCmatured, rec_bucket)
```

#### Age of Credit history:
The age of credit history has a significant impact on default rates: Fully paying borrowers tend to have slightly older credit history, which is to be expected.
But the main take on Credit history is on borrower that have relatively short credit history: We can see that the bottom 10% have credit histories of less than 6 years and have a significantly higher default rates.
*One should also be careful when looking into the age of the credit history since it correlates with the age of the borrower and hence with his income and other features. This will need to be investigated further later.*
```{r}
# Report showing the amounts and number of loans in each category, here the age of the credit history of the borrower.
sumAmnts(LCmatured, credit_ym_bucket)
# Report showing some statistics for each category, here the age of the credit history of the borrower.
sumPerSatus(LCmatured, credit_ym_bucket)
```

#### Revolving utilization:
As expected, higher revolving utilization mean higher risk of default.
The top 10% has default rates that are almost twice as low as the bottom 10%.
```{r}
# Report showing the amounts and number of loans in each category, here the revolving utilization of the borrower.
sumAmnts(LCmatured, revol_bucket)
# Report showing some statistics for each category, here the revolving utilization of the borrower.
sumPerSatus(LCmatured, revol_bucket)
```

#### Annual income:
This is a very strong feature. People in the top 20% quantile have half as much charged off loans compared to the bottom 20%. It is worth noticing though, that even the top 20% still get a 9.5% chance off defaulting on their loan which is still very high. So annual income is not a silver bullet either.
```{r}
# Report showing the amounts and number of loans in each category, here the annual income of the borrower.
sumAmnts(LCmatured, annual_inc_bucket)
# Report showing some statistics for each category, here the age of the annual income of the borrower.
sumPerSatus(LCmatured, annual_inc_bucket)
```

#### Inquiries in the last 6months:
This feature is supposed to represent how desperate the borrower is for credit. We can see that the correlation between this feature and charged off rates is very strong. This is the feature that has the highest impact on default rates. The EL of people with 0 Inquiries is more than 4 times smaller than the EL of the 7+ bucket!
```{r}
# Report showing the amounts and number of loans in each category, here the number of Inquiries of the borrower.
sumAmnts(LCmatured, inq_bucket)
# Report showing some statistics for each category, here the age of the number of Inquiries of the borrower.
sumPerSatus(LCmatured, inq_bucket)
```

#### Geography:
Finally, here is a heat map of the USA. We see that Nevada is not doing so great...
```{r, fig.width=10}
# options:
l <- list(color = toRGB("steelblue"), width = 1)
g = list(scope = 'usa', projection = list(type = 'albers usa'), showlakes = F, lakecolor = toRGB('white'))
# plotting the map:
plot_ly(filter(sumStates, n > 200), z = charged, text = hover, locations = addr_state, type = 'choropleth',
        locationmode = 'USA-states', color = total_issued, colors = 'Oranges',
        marker = list(line = l), colorbar = list(title = "Default rates<br>in percentage")) %>%
  layout(title = 'DEFAULT RATES PER STATES<br>(Hover for breakdown)', geo = g)
```


## Conclusion

Lending Club's data is a great source of information on personal credit. Additionally this data set is bound to grow exponentially over the next years. We tried to build a report to both present Lending Club and build the foundations to more in depth analyses.

##### To continue this analysis we need to be careful with the following:
1. There is a geographical selection bias: as we saw in the previous maps most accounts are very concentrated geographically.
2. By nature of the platform, we are selecting only applicants who are somewhat tech-savvy.  
3. We need to be careful with the implications of certain features when trying to extract correlation. As stated earlier, features like number of accounts or age of credit history are correlated to the age of the borrower. Could their relationship to default rates be linked to their age and indirectly to their income?
4. We have to be careful with adverse selection, a mistake that the financial industry as know for a long time. Let's keep in mind that the safe way to do financial services is to keep the segmentation down to a minimum and let the mathematics of risk pooling look after us.

##### The next steps of this analysis could be some of the following:
1. Building a credit model and see if we can predict reliably defaults.  
2. Building a model to arb LC's own model.  
3. Trying to replicate LC's models using machine learning techniques using the Lending Club's grades as our outputs.


